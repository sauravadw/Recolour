<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TV Sale & Bill App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* General Styling */
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f3f4f6;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .container {
      padding: 16px;
      max-width: 600px;
      margin: auto;
    }

    h2, h3, h4 {
      font-weight: 700;
      color: #2c3e50;
      margin: 16px 0;
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      outline: none;
      box-sizing: border-box;
    }

    /* Buttons Styling */
    button {
      background: linear-gradient(135deg, #6c5ce7, #74b9ff);
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background: linear-gradient(135deg, #4a47a3, #54a0ff);
    }

    /* Card Styling */
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h4 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #34495e;
    }

    .card p {
      margin: 0;
      font-size: 14px;
      color: #7f8c8d;
    }

    /* Section Headers */
    .section-header {
      font-size: 18px;
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    /* Input Group with Icon */
    .input-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.input-group input {
  flex: 1; /* Allow the input to take up remaining space */
  font-size: 14px;
}

.input-group button {
  flex-shrink: 0; /* Prevent button from shrinking */
  width: 40px; /* Fixed width for the button */
  height: 40px; /* Fixed height for the button */
  padding: 8px;
  background-color: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.input-group button img {
  width: 20px;
  height: 20px;
}

    /* Responsive Adjustments */
    @media (max-width: 480px) {
      input, select, button {
        font-size: 14px;
        padding: 10px;
      }
    }
	.button-container {
  display: flex;
  gap: 10px; /* Adds spacing between buttons */
}

.card.button-container button {
  width: auto; /* Allow buttons to size dynamically */
  flex: 1; /* Optional: Adjust to ensure even spacing and size */
}
  </style>
</head>
<body>
  <div class="container">
    <h2>TV Sale Tracker</h2>

    <!-- Customer Info -->
    <div class="card">
      <h4>Customer Details</h4>
      <input type="text" id="customerName" placeholder="Customer Name" />
      <input type="date" id="saleDate" />
    </div>

    <!-- Add Item -->
    <div class="card">
      <h4>Add Item</h4>
      <input type="text" id="modelSelect" placeholder="Enter or Search Model" list="modelList" />
      <datalist id="modelList"></datalist>

      <div class="input-group">
        <input id="serialSingle" type="text" placeholder="Serial Number" />
        <button onclick="launchCameraScan()" title="Scan with Camera">
          <img src="https://img.icons8.com/ios-filled/50/cccccc/camera.png" alt="Scan" />
        </button>
      </div>

      <input type="number" id="amountSingle" placeholder="Amount" min="0" />
      <button onclick="addItemToBill()">+ Add Item</button>
    </div>

    <!-- Item List -->
    <div class="card" id="itemList">
      <h4>Items</h4>
      <p>No items added yet.</p>
    </div>

    <!-- Action Buttons -->
    <div class="card button-container">
  <button onclick="addSale()">Generate & Save</button>
  <button onclick="saveOnly()">Save Only</button>
</div>

    <!-- Search -->
    <div class="card">
      <h4>Search</h4>
      <input type="text" id="searchInput" placeholder="Search by Customer, Model, or Serial" />
      <button id="searchDataButton" onclick="searchSale()">Load Data & Search</button>
	  <div id="searchResult"></div>
    </div>

    <!-- Recent Bills -->
    <div class="card" id="recentBills">
      <h4>Last 10 Bills</h4>
      <p>No recent bills found.</p>
    </div>
  </div>

<script>
// Firebase Initialization
const firebaseConfig = {
apiKey: "AIzaSyBk1nM3mxmzGQLujguCoNfNegZ49CEg8lQ",
authDomain: "tvsale-468ea.firebaseapp.com",
projectId: "tvsale-468ea",
storageBucket: "tvsale-468ea.appspot.com",
messagingSenderId: "39621283204",
appId: "1:39621283204:web:36e863ae469372a32e21d1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let items = [];
let fuse; // Declare fuse for search

async function addSale() {
  const name = document.getElementById('customerName').value.trim();
  const amount = items.reduce((sum, item) => sum + item.amount, 0);
  const message = document.getElementById('message');

  if (!name || items.length === 0) {
    message.textContent = 'Please fill all fields and add items.';
    return;
  }

  try {
    // Run a Firestore transaction safely
    const currentInvoice = await db.runTransaction(async (transaction) => {
      const counterRef = db.collection('meta').doc('counters');
      const counterSnap = await transaction.get(counterRef);

      let invoiceNumber = 1; // Default to 1 if the document doesn't exist

      if (counterSnap.exists) {
        invoiceNumber = counterSnap.data().invoiceNumber + 1;
        transaction.update(counterRef, {
          invoiceNumber: firebase.firestore.FieldValue.increment(1),
        });
      } else {
        transaction.set(counterRef, { invoiceNumber: 1 });
      }

      return invoiceNumber;
    });

    // Prepare bill data
    const docData = {
      invoiceNumber: currentInvoice,
      customerName: name,
      customerNameLower: name.toLowerCase(),
      dateOfSale: firebase.firestore.Timestamp.now(),
      items,
      totalAmount: amount,
    };

    // Save the sale record
    await db.collection('sales').add(docData);

    // Generate PDF
    generatePDF(name, new Date(), items, amount, currentInvoice);

    message.textContent = 'Bill generated and saved!';
    resetForm();
    loadRecentBills();
  } catch (err) {
    console.error(err);
    message.textContent = 'Error saving sale.';
  }
}
  async function saveOnly() {
  const name = document.getElementById('customerName').value.trim();
  const saleDate = document.getElementById('saleDate').value;
  const amount = items.reduce((sum, item) => sum + item.amount, 0);
  const message = document.getElementById('message');

  if (!name || items.length === 0 || !saleDate) {
    message.textContent = 'Please fill all fields and add items.';
    return;
  }

  try {
    // Run a Firestore transaction safely
    const newInvoiceNumber = await db.runTransaction(async (transaction) => {
      const counterRef = db.collection('meta').doc('counters');
      const counterSnap = await transaction.get(counterRef);

      let invoiceNumber = 1; // Default to 1 if the document doesn't exist

      if (counterSnap.exists) {
        invoiceNumber = counterSnap.data().invoiceNumber + 1;
        transaction.update(counterRef, {
          invoiceNumber: firebase.firestore.FieldValue.increment(1),
        });
      } else {
        transaction.set(counterRef, { invoiceNumber: 1 });
      }

      return invoiceNumber;
    });

    // Prepare bill data
    const docData = {
      customerName: name,
      customerNameLower: name.toLowerCase(),
      dateOfSale: firebase.firestore.Timestamp.fromDate(new Date(saleDate)),
      items,
      totalAmount: amount,
      invoiceNumber: newInvoiceNumber,
    };

    await db.collection('sales').add(docData);

    message.textContent = 'Bill saved successfully (PDF not generated).';
    resetForm();
    loadRecentBills();
  } catch (err) {
    console.error(err);
    message.textContent = 'Error saving sale.';
  }
}
function generatePDF(name, saleDate, items, totalAmount, invoiceNumber = '-', customerAddress = '', customerPhone = '') {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Colors and Layout Variables
  const primaryColor = [47, 128, 237]; // Blue
  const secondaryColor = [34, 34, 34]; // Dark Gray
  const lightGray = [240, 240, 240]; // Light Gray for background
  const margin = 20;
  const rowHeight = 8; // Height for each row in the table

  let y = 20;

  // Add a Light Background Box for the Header
  doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.rect(0, 0, 210, 40, 'F'); // Full-width header background

  // Header Section
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(22);
  doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
  doc.text("INVOICE", margin, y);

  y += 8;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(12);
  doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
  doc.text("MY TV SALES STORE", margin, y);
  doc.text("123 Market Road, Cityname, PIN 123456", margin, y + 5);
  doc.text("Contact: +91-9876543210 | Email: sales@tvstore.com", margin, y + 10);

  // Invoice Info Section
  y += 20;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.text(`Invoice #: ${invoiceNumber}`, margin, y);
  doc.text(`Date: ${saleDate.toLocaleDateString()}`, 210 - margin, y, { align: 'right' });

  y += 8;
  doc.text(`Customer Name: ${name}`, margin, y);
  y += 6;
  if (customerAddress) doc.text(`Address: ${customerAddress}`, margin, y);
  y += 6;
  if (customerPhone) doc.text(`Phone: ${customerPhone}`, margin, y);

  // Table Header
  y += 10;
  const tableStartY = y;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]); // Blue Background
  doc.setTextColor(255, 255, 255); // White Text
  doc.rect(margin, y, 170, 10, 'F'); // Table Header Background

  doc.text("S.No", margin + 2, y + 7);
  doc.text("Model", margin + 20, y + 7);
  doc.text("Serial No.", margin + 85, y + 7);
  doc.text("Amount", 210 - margin - 10, y + 7, { align: 'right' });

  // Table Rows
  y += 16; // Add proper spacing between the header and the first row
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);

  items.forEach((item, index) => {
    // Check if the row will fit on the page. If not, add a new page.
    if (y + rowHeight > 280) {
      doc.addPage();
      y = margin; // Reset y for the new page
    }

    doc.text(`${index + 1}`, margin + 2, y);
    doc.text(item.model, margin + 20, y);
    doc.text(item.serialNumber, margin + 85, y);
    doc.text(`${item.amount.toFixed(2)}`, 210 - margin - 10, y, { align: 'right' });
    y += rowHeight; // Increment y for the next row
  });

  // Total Section
  y += 5;
  doc.setLineWidth(0.5);
  doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.line(margin, y, 210 - margin, y); // Separator Line

  y += 10;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(14);
  doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
  doc.text("Total Amount:", 210 - margin - 40, y, { align: 'right' });
  doc.text(`${totalAmount.toFixed(2)}`, 210 - margin - 10, y, { align: 'right' });

  // Footer Section
  y += 20;
  doc.setFont('helvetica', 'italic');
  doc.setFontSize(10);
  doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
  doc.text("Thank you for your purchase!", 105, y, { align: 'center' });

  // Add Footer Line
  y += 10;
  doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.line(margin, y, 210 - margin, y);

  y += 5;
  doc.setFontSize(8);
  doc.text("This invoice was generated electronically and is valid without a signature.", 105, y, { align: 'center' });

  // Open PDF in a new window
  doc.output('dataurlnewwindow');
}
async function addItemToBill() {
  const model = document.getElementById('modelSelect').value.trim(); // Fixed ID
  const serial = document.getElementById('serialSingle').value.trim();
  const amount = parseFloat(document.getElementById('amountSingle').value);

  if (!model || !serial || isNaN(amount)) {
    alert('Please fill in all item fields correctly.');
    return;
  }

  if (!modelList.includes(model)) {
    try {
      await db.collection('models').add({ model });
      modelList.push(model);
      const option = document.createElement('option');
      option.value = model;
      document.getElementById('modelList').appendChild(option); // Fixed ID
      console.log(`New model "${model}" added to Firestore.`);
    } catch (err) {
      console.error("Error adding new model:", err);
    }
  }

  items.push({
    model,
    serialNumber: serial,
    amount
  });

  document.getElementById('modelSelect').value = ''; // Fixed ID
  document.getElementById('serialSingle').value = '';
  document.getElementById('amountSingle').value = '';
  updateItemList();
}

function removeItem(idx) {
items.splice(idx, 1);
updateItemList();
}
function updateItemList() {
const itemListDiv = document.getElementById('itemList');
itemListDiv.innerHTML = '';

items.forEach((item, idx) => {
const div = document.createElement('div');
div.classList.add('item-box');
div.innerHTML = `
<strong>${item.model}</strong> - ${item.serialNumber} - ${item.amount.toFixed(2)}
<button onclick="removeItem(${idx})">Remove</button>
`;
itemListDiv.appendChild(div);
});
}


async function loadRecentBills() {
const recentDiv = document.getElementById('recentBills');
recentDiv.innerHTML = '<p>Loading...</p>';

try {
// Get the last 10 bills ordered by invoice number
const snapshot = await db.collection('sales')
.orderBy('invoiceNumber', 'desc') // Sort by invoiceNumber instead of date
.limit(10)
.get();

if (snapshot.empty) {
recentDiv.innerHTML = '<p>No recent bills found.</p>';
return;
}

let html = '<ul style="list-style: none; padding: 0;">';
snapshot.forEach(doc => {
const data = doc.data();
const date = data.dateOfSale.toDate();
html += `
<li style="margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 5px; border: 1px solid #ccc;">
<strong>Invoice #${data.invoiceNumber}</strong><br>
<strong>${data.customerName}</strong><br>
Date: ${date.toLocaleDateString()}<br>
Total: ${data.totalAmount}<br>
<div class="button-container">
    <button onclick='generatePDF("${data.customerName}", new Date("${date.toISOString()}"), ${JSON.stringify(data.items).replace(/"/g, '&quot;')}, ${data.totalAmount}, ${data.invoiceNumber})'>View PDF</button>
    <button onclick='editBill("${doc.id}")'>Edit Bill</button>
  </div>
</li>
`;
});
html += '</ul>';
recentDiv.innerHTML = html;
} catch (err) {
console.error(err);
recentDiv.innerHTML = '<p>Error loading recent bills.</p>';
}
}


async function searchSale() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  const resultDiv = document.getElementById('searchResult');
  resultDiv.innerHTML = ''; // Clear previous results

  if (!query) {
    resultDiv.innerHTML = '<p>Please enter a search query.</p>';
    return;
  }

  try {
    // Fetch all sales data from Firestore
    const snapshot = await db.collection('sales').get();
    const allSales = [];

    snapshot.forEach(doc => {
      allSales.push({ id: doc.id, ...doc.data() });
    });

    // Initialize Fuse.js for fuzzy searching
    const fuse = new Fuse(allSales, {
      keys: [
        'customerNameLower',  // Search by customer name (lowercased)
        'items.model',        // Search by item model
        'items.serialNumber', // Search by serial number
        'invoiceNumber'       // Search by invoice number
      ],
      threshold: 0.4 // Controls search sensitivity (0.0 = exact match, 1.0 = very loose)
    });

    // Perform search
    const fuzzyResults = fuse.search(query).map(res => res.item);

    if (fuzzyResults.length === 0) {
      resultDiv.innerHTML = '<p>No matching records found.</p>';
      return;
    }

    // Sort results by date of sale (most recent first)
    fuzzyResults.sort((a, b) => b.dateOfSale.toDate().getTime() - a.dateOfSale.toDate().getTime());

    // Generate result HTML
    let html = '<ul style="list-style: none; padding: 0;">';
    fuzzyResults.forEach(data => {
      const date = data.dateOfSale.toDate();
      html += `
        <li style="margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 5px; border: 1px solid #ccc;">
          <strong>${data.customerName}</strong><br>
          Invoice Number: ${data.invoiceNumber}<br> <!-- Display invoice number -->
          Date: ${date.toLocaleDateString()}<br>
          Total: ${data.totalAmount}<br>
          <button onclick='generatePDF("${data.customerName}", new Date("${date.toISOString()}"), ${JSON.stringify(data.items).replace(/"/g, '&quot;')}, ${data.totalAmount}, ${data.invoiceNumber})'>View PDF</button>
          <button onclick='editBill("${data.id}")'>Edit Bill</button> <!-- Edit Button -->
        </li>
      `;
    });
    html += '</ul>';
    resultDiv.innerHTML = html;

  } catch (err) {
    console.error(err);
    resultDiv.innerHTML = '<p>Error during search.</p>';
  }
}

// Function to open the bill in editable form
async function editBill(billId) {
const messageDiv = document.getElementById('message');
messageDiv.textContent = "Loading bill for editing...";

try {
// Get the selected bill data from Firestore
const doc = await db.collection('sales').doc(billId).get();
const bill = doc.data();

// Populate the editable form with the bill data
document.getElementById('customerName').value = bill.customerName;
document.getElementById('saleDate').value = bill.dateOfSale.toDate().toISOString().split('T')[0]; // Format as YYYY-MM-DD
items = bill.items; // Set the items array to the current bill items
updateItemList(); // Update the item list (reuse your existing updateItemList function)

// Add a Save Changes button
messageDiv.innerHTML = `
<button onclick="saveEditedBill('${billId}')">Save Changes</button>
`;
} catch (err) {
console.error(err);
messageDiv.textContent = "Error loading bill for editing.";
}
}

// Save edited bill
async function saveEditedBill(billId) {
const name = document.getElementById('customerName').value.trim();
const saleDate = document.getElementById('saleDate').value;
const amount = items.reduce((sum, item) => sum + item.amount, 0);
const message = document.getElementById('message');

if (!name || items.length === 0 || !saleDate) {
message.textContent = 'Please fill all fields and add items.';
return;
}

const docData = {
customerName: name,
customerNameLower: name.toLowerCase(),
dateOfSale: firebase.firestore.Timestamp.fromDate(new Date(saleDate)),
items,
totalAmount: amount,
};

try {
await db.collection('sales').doc(billId).update(docData);
message.textContent = 'Bill updated successfully!';
resetForm();
loadRecentBills(); // Refresh last 10 bills
} catch (err) {
console.error(err);
message.textContent = 'Error saving edited bill.';
}
}

function resetForm() {
  document.getElementById('customerName').value = '';
  document.getElementById('saleDate').valueAsDate = new Date();
  document.getElementById('serialSingle').value = '';
  document.getElementById('modelInput').value = '';
  document.getElementById('amountSingle').value = '';
  items = [];
  updateItemList();
  document.getElementById('message').textContent = '';
}

function launchCameraScan() {
  const userAgent = navigator.userAgent.toLowerCase();

  if (userAgent.includes('android')) {
    // Open Google Lens (Android only)
    window.location.href = "intent://lens.google.com/#Intent;scheme=https;package=com.google.ar.lens;end";
  } else {
    alert("Camera scan is only supported on Android using Google Lens. Please manually enter the serial number.");
  }
}

async function loadModels() {
  const modelInput = document.getElementById('modelSelect'); // Fixed ID
  const dataList = document.getElementById('modelList');     // Fixed ID
  dataList.innerHTML = '';
  modelList = [];

  const snapshot = await db.collection('models').orderBy('model').get();
  snapshot.forEach(doc => {
    const modelName = doc.data().model;
    modelList.push(modelName);
    const option = document.createElement('option');
    option.value = modelName;
    dataList.appendChild(option);
  });
}

window.onload = () => {
loadModels();
loadRecentBills();
document.getElementById('saleDate').valueAsDate = new Date();
};
</script>
</body>
</html>
